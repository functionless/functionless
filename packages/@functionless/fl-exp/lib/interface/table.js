"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TableAttributesClient = exports.TableDocumentClient = exports.Table = exports.isTableDecl = exports.TableKind = void 0;
const dynamodb_1 = __importDefault(require("aws-sdk/clients/dynamodb"));
const dynamodb_2 = require("aws-sdk/clients/dynamodb");
const util_1 = require("../util");
const client_1 = require("./client");
exports.TableKind = "fl.Table";
function isTableDecl(a) {
    return (a === null || a === void 0 ? void 0 : a.kind) === exports.TableKind;
}
exports.isTableDecl = isTableDecl;
const documentClient = (0, client_1.createClientFactory)(dynamodb_2.DocumentClient);
const dynamoClient = (0, client_1.createClientFactory)(dynamodb_1.default);
function Table(props, 
/**
 * Injected by the compiler.
 */
resourceId, 
/**
 * Injected by the compiler.
 */
roleArn) {
    return new TableDocumentClient(props, resourceId, roleArn);
}
exports.Table = Table;
class TableDocumentClient {
    constructor(props, resourceId, roleArn) {
        this.props = props;
        this.resourceId = resourceId;
        this.roleArn = roleArn;
        this.kind = exports.TableKind;
        this.attributes = new TableAttributesClient(resourceId, roleArn);
    }
    getEnvironmentKey() {
        return (0, util_1.getEnvironmentVariableName)(this.resourceId);
    }
    getTableArn() {
        return process.env[`${this.getEnvironmentKey()}_ARN`];
    }
    getTableName() {
        return process.env[`${this.getEnvironmentKey()}_NAME`];
    }
    async get(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await documentClient(this.roleArn)).get(input).promise();
    }
    async put(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await documentClient(this.roleArn)).put(input).promise();
    }
    async update(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await documentClient(this.roleArn)).update(input).promise();
    }
    async delete(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await documentClient(this.roleArn)).delete(input).promise();
    }
    async query(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await documentClient(this.roleArn)).query(input).promise();
    }
    async scan(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await documentClient(this.roleArn)).scan(input).promise();
    }
    async batchGet(request) {
        var _a;
        const input = {
            RequestItems: {
                [this.getTableName()]: request,
            },
        };
        const response = await (await documentClient(this.roleArn))
            .batchGet(input)
            .promise();
        return {
            ...response,
            Items: (_a = response.Responses) === null || _a === void 0 ? void 0 : _a[this.getTableName()],
        };
    }
    async batchWrite(request) {
        var _a;
        const input = {
            RequestItems: {
                [this.getTableName()]: request,
            },
        };
        const response = await (await documentClient(this.roleArn))
            .batchWrite(input)
            .promise();
        return {
            ...response,
            UnprocessedItems: (_a = response.UnprocessedItems) === null || _a === void 0 ? void 0 : _a[this.getTableName()],
        };
    }
    async transactGet({ TransactItems }) {
        var _a;
        const input = {
            TransactItems: TransactItems.map((item) => ({
                Get: {
                    ...item.Get,
                    TableName: this.getTableName(),
                },
            })),
        };
        const response = await (await documentClient(this.roleArn))
            .transactGet(input)
            .promise();
        return {
            Items: (_a = response.Responses) === null || _a === void 0 ? void 0 : _a.map(({ Item }) => Item),
        };
    }
    async transactWrite({ TransactItems }) {
        const input = {
            TransactItems: TransactItems.flatMap((item) => Object.keys(item).map((key) => ({
                [key]: {
                    ...item[key],
                    TableName: this.getTableName(),
                },
            }))),
        };
        return await (await documentClient(this.roleArn))
            .transactWrite(input)
            .promise();
    }
}
exports.TableDocumentClient = TableDocumentClient;
class TableAttributesClient {
    constructor(resourceId, roleArn) {
        this.resourceId = resourceId;
        this.roleArn = roleArn;
    }
    getEnvironmentKey() {
        return (0, util_1.getEnvironmentVariableName)(this.resourceId);
    }
    getTableArn() {
        return process.env[`${this.getEnvironmentKey()}_ARN`];
    }
    getTableName() {
        return process.env[`${this.getEnvironmentKey()}_NAME`];
    }
    async get(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await dynamoClient(this.roleArn)).getItem(input).promise();
    }
    async put(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await dynamoClient(this.roleArn)).putItem(input).promise();
    }
    async update(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await dynamoClient(this.roleArn)).updateItem(input).promise();
    }
    async delete(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await dynamoClient(this.roleArn)).deleteItem(input).promise();
    }
    async query(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await dynamoClient(this.roleArn)).query(input).promise();
    }
    async scan(request) {
        const input = {
            ...request,
            TableName: this.getTableName(),
        };
        return await (await dynamoClient(this.roleArn)).scan(input).promise();
    }
    async batchGet(request) {
        var _a;
        const input = {
            RequestItems: {
                [this.getTableName()]: request,
            },
        };
        const response = await (await dynamoClient(this.roleArn))
            .batchGetItem(input)
            .promise();
        return {
            ...response,
            Items: (_a = response.Responses) === null || _a === void 0 ? void 0 : _a[this.getTableName()],
        };
    }
    async batchWrite(request) {
        var _a;
        const input = {
            RequestItems: {
                [this.getTableName()]: request,
            },
        };
        const response = await (await dynamoClient(this.roleArn))
            .batchWriteItem(input)
            .promise();
        return {
            ...response,
            UnprocessedItems: (_a = response.UnprocessedItems) === null || _a === void 0 ? void 0 : _a[this.getTableName()],
        };
    }
    async transactGet({ TransactItems }) {
        var _a;
        const input = {
            TransactItems: TransactItems.map((item) => ({
                Get: {
                    ...item.Get,
                    TableName: this.getTableName(),
                },
            })),
        };
        const response = await (await dynamoClient(this.roleArn))
            .transactGetItems(input)
            .promise();
        return {
            Items: (_a = response.Responses) === null || _a === void 0 ? void 0 : _a.map(({ Item }) => Item),
        };
    }
    async transactWrite({ TransactItems }) {
        const input = {
            TransactItems: TransactItems.flatMap((item) => Object.keys(item).map((key) => ({
                [key]: {
                    ...item[key],
                    TableName: this.getTableName(),
                },
            }))),
        };
        return await (await dynamoClient(this.roleArn))
            .transactWriteItems(input)
            .promise();
    }
}
exports.TableAttributesClient = TableAttributesClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW50ZXJmYWNlL3RhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUtBLHdFQUFnRDtBQUNoRCx1REFBMEQ7QUFDMUQsa0NBQXFEO0FBQ3JELHFDQUErQztBQUVsQyxRQUFBLFNBQVMsR0FBRyxVQUFVLENBQUM7QUF3RXBDLFNBQWdCLFdBQVcsQ0FBQyxDQUFNO0lBQ2hDLE9BQU8sQ0FBQSxDQUFDLGFBQUQsQ0FBQyx1QkFBRCxDQUFDLENBQUUsSUFBSSxNQUFLLGlCQUFTLENBQUM7QUFDL0IsQ0FBQztBQUZELGtDQUVDO0FBY0QsTUFBTSxjQUFjLEdBQUcsSUFBQSw0QkFBbUIsRUFBQyx5QkFBYyxDQUFDLENBQUM7QUFFM0QsTUFBTSxZQUFZLEdBQUcsSUFBQSw0QkFBbUIsRUFBQyxrQkFBUSxDQUFDLENBQUM7QUFhbkQsU0FBZ0IsS0FBSyxDQUtuQixLQUdDO0FBQ0Q7O0dBRUc7QUFDSCxVQUFtQjtBQUNuQjs7R0FFRztBQUNILE9BQWdCO0lBRWhCLE9BQU8sSUFBSSxtQkFBbUIsQ0FBQyxLQUFZLEVBQUUsVUFBVyxFQUFFLE9BQU8sQ0FBUSxDQUFDO0FBQzVFLENBQUM7QUFuQkQsc0JBbUJDO0FBRUQsTUFBYSxtQkFBbUI7SUFROUIsWUFDVyxLQUdSLEVBQ1EsVUFBa0IsRUFDbEIsT0FBZ0I7UUFMaEIsVUFBSyxHQUFMLEtBQUssQ0FHYjtRQUNRLGVBQVUsR0FBVixVQUFVLENBQVE7UUFDbEIsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQVRsQixTQUFJLEdBQUcsaUJBQVMsQ0FBQztRQVd4QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUkscUJBQXFCLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ25FLENBQUM7SUFFTyxpQkFBaUI7UUFDdkIsT0FBTyxJQUFBLGlDQUEwQixFQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNyRCxDQUFD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RUFBRSxDQUNqRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDOUIsQ0FBQyxHQUFHLENBQUMsRUFBRTtvQkFDTCxHQUFHLElBQUksQ0FBQyxHQUF3QixDQUFDO29CQUNqQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRTtpQkFDL0I7YUFDRixDQUFDLENBQUMsQ0FDSjtTQUNGLENBQUM7UUFDRixPQUFPLE1BQU0sQ0FBQyxNQUFNLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDNUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDO2FBQ3pCLE9BQU8sRUFBRSxDQUFDO0lBQ2YsQ0FBQztDQUNGO0FBM0hELHNEQTJIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlICogYXMgZnVuY3Rpb25sZXNzIGZyb20gXCJmdW5jdGlvbmxlc3NcIjtcbmltcG9ydCB0eXBlIHsgYXdzX2R5bmFtb2RiIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBUYWJsZUFwcHN5bmNBcGkgfSBmcm9tIFwiLi90YWJsZS9hcHBzeW5jXCI7XG5pbXBvcnQgeyBBdHRyaWJ1dGVUeXBlIH0gZnJvbSBcIi4vdGFibGUvYXR0cmlidXRlLXR5cGVcIjtcbmltcG9ydCB7IFRhYmxlQXR0cmlidXRlc0FwaSwgVGFibGVEb2N1bWVudEFwaSB9IGZyb20gXCIuL3RhYmxlL3J1bnRpbWVcIjtcbmltcG9ydCBEeW5hbW9EQiBmcm9tIFwiYXdzLXNkay9jbGllbnRzL2R5bmFtb2RiXCI7XG5pbXBvcnQgeyBEb2N1bWVudENsaWVudCB9IGZyb20gXCJhd3Mtc2RrL2NsaWVudHMvZHluYW1vZGJcIjtcbmltcG9ydCB7IGdldEVudmlyb25tZW50VmFyaWFibGVOYW1lIH0gZnJvbSBcIi4uL3V0aWxcIjtcbmltcG9ydCB7IGNyZWF0ZUNsaWVudEZhY3RvcnkgfSBmcm9tIFwiLi9jbGllbnRcIjtcblxuZXhwb3J0IGNvbnN0IFRhYmxlS2luZCA9IFwiZmwuVGFibGVcIjtcblxuZXhwb3J0IGludGVyZmFjZSBUYWJsZVByb3BzPFxuICBQYXJ0aXRpb25LZXkgZXh0ZW5kcyBzdHJpbmcsXG4gIFJhbmdlS2V5IGV4dGVuZHMgc3RyaW5nIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkXG4+IGV4dGVuZHMgT21pdDxcbiAgICBhd3NfZHluYW1vZGIuVGFibGVQcm9wcyxcbiAgICBcInBhcnRpdGlvbktleVwiIHwgXCJzb3J0S2V5XCIgfCBcInRhYmxlTmFtZVwiXG4gID4ge1xuICAvKipcbiAgICogRW5mb3JjZXMgYSBwYXJ0aWN1bGFyIHBoeXNpY2FsIHRhYmxlIG5hbWUuXG4gICAqIEBkZWZhdWx0IGdlbmVyYXRlZFxuICAgKlxuICAgKiBbSW50ZXJuYWwgTm90ZV0gdGhpcyBwcm9wZXJ0eSBpcyBjb3BpZWQgYmVjYXVzZSBDREsgdHNkb2NzIGhhdmUgYSB4bWwgbGlrZSB0YWdcbiAgICogICAgICAgICAgICAgICAgIGFyb3VuZCBgZ2VuZXJhdGVkYCB3aGljaCBicmVha3MgdHlwZWRvY3MuXG4gICAqL1xuICByZWFkb25seSB0YWJsZU5hbWU/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBQYXJ0aXRpb24ga2V5IGF0dHJpYnV0ZSBkZWZpbml0aW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgcGFydGl0aW9uS2V5OiB7XG4gICAgbmFtZTogUGFydGl0aW9uS2V5O1xuICAgIHR5cGU6IEF0dHJpYnV0ZVR5cGU7XG4gIH07XG4gIC8qKlxuICAgKiBTb3J0IGtleSBhdHRyaWJ1dGUgZGVmaW5pdGlvbi5cbiAgICpcbiAgICogQGRlZmF1bHQgbm8gc29ydCBrZXlcbiAgICovXG4gIHJlYWRvbmx5IHNvcnRLZXk/OiBSYW5nZUtleSBleHRlbmRzIHVuZGVmaW5lZFxuICAgID8gdW5kZWZpbmVkXG4gICAgOiB7IG5hbWU6IEV4Y2x1ZGU8UmFuZ2VLZXksIHVuZGVmaW5lZD47IHR5cGU6IEF0dHJpYnV0ZVR5cGUgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUYWJsZTxcbiAgSXRlbSBleHRlbmRzIG9iamVjdCxcbiAgUGFydGl0aW9uS2V5IGV4dGVuZHMga2V5b2YgSXRlbSxcbiAgUmFuZ2VLZXkgZXh0ZW5kcyBrZXlvZiBJdGVtIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkXG4+IGV4dGVuZHMgVGFibGVEb2N1bWVudEFwaTxJdGVtLCBQYXJ0aXRpb25LZXksIFJhbmdlS2V5PiB7XG4gIHJlYWRvbmx5IGtpbmQ6IFwiVGFibGVcIjtcblxuICAvKipcbiAgICogVGhlIHVuZGVybHlpbmcge0BsaW5rIGF3c19keW5hbW9kYi5JVGFibGV9IFJlc291cmNlLlxuICAgKi9cbiAgcmVhZG9ubHkgcmVzb3VyY2U6IGF3c19keW5hbW9kYi5JVGFibGU7XG5cbiAgLyoqXG4gICAqIE5hbWUgb2YgdGhpcyB0YWJsZS5cbiAgICovXG4gIHJlYWRvbmx5IHRhYmxlTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgQVJOIG9mIHRoaXMgdGFibGUuXG4gICAqL1xuICByZWFkb25seSB0YWJsZUFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBCcmFuZHMgdGhpcyB0eXBlIHdpdGggZWFzeS1hY2Nlc3MgdG8gdGhlIHR5cGUgcGFyYW1ldGVycywgSXRlbSwgUGFydGl0aW9uS2V5IGFuZCBSYW5nZUtleVxuICAgKlxuICAgKiBAbm90ZSB0aGlzIHZhbHVlIHdpbGwgbmV2ZXIgZXhpc3QgYXQgcnVudGltZSAtIGl0IGlzIHB1cmVseSBjb21waWxlLXRpbWUgaW5mb3JtYXRpb25cbiAgICovXG4gIHJlYWRvbmx5IF9icmFuZD86IHtcbiAgICBJdGVtOiBJdGVtO1xuICAgIFBhcnRpdGlvbktleTogUGFydGl0aW9uS2V5O1xuICAgIFJhbmdlS2V5OiBSYW5nZUtleTtcbiAgfTtcblxuICByZWFkb25seSBhcHBzeW5jOiBUYWJsZUFwcHN5bmNBcGk8SXRlbSwgUGFydGl0aW9uS2V5LCBSYW5nZUtleT47XG5cbiAgcmVhZG9ubHkgYXR0cmlidXRlczogVGFibGVBdHRyaWJ1dGVzQXBpPEl0ZW0sIFBhcnRpdGlvbktleSwgUmFuZ2VLZXk+O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNUYWJsZURlY2woYTogYW55KTogYSBpcyBUYWJsZURlY2wge1xuICByZXR1cm4gYT8ua2luZCA9PT0gVGFibGVLaW5kO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRhYmxlRGVjbDxcbiAgSXRlbSBleHRlbmRzIG9iamVjdCA9IG9iamVjdCxcbiAgUEsgZXh0ZW5kcyBrZXlvZiBJdGVtID0ga2V5b2YgSXRlbSxcbiAgU0sgZXh0ZW5kcyBrZXlvZiBJdGVtIHwgdW5kZWZpbmVkID0ga2V5b2YgSXRlbSB8IHVuZGVmaW5lZFxuPiB7XG4gIGtpbmQ6IHR5cGVvZiBUYWJsZUtpbmQ7XG4gIHByb3BzOiBmdW5jdGlvbmxlc3MuVGFibGVQcm9wczxcbiAgICBFeGNsdWRlPFBLLCBudW1iZXIgfCBTeW1ib2w+LFxuICAgIEV4Y2x1ZGU8U0ssIG51bWJlciB8IFN5bWJvbD5cbiAgPjtcbn1cblxuY29uc3QgZG9jdW1lbnRDbGllbnQgPSBjcmVhdGVDbGllbnRGYWN0b3J5KERvY3VtZW50Q2xpZW50KTtcblxuY29uc3QgZHluYW1vQ2xpZW50ID0gY3JlYXRlQ2xpZW50RmFjdG9yeShEeW5hbW9EQik7XG5cbmV4cG9ydCBmdW5jdGlvbiBUYWJsZTxcbiAgSXRlbSBleHRlbmRzIG9iamVjdCxcbiAgUEsgZXh0ZW5kcyBrZXlvZiBJdGVtLFxuICBTSyBleHRlbmRzIGtleW9mIEl0ZW0gfCB1bmRlZmluZWQgPSB1bmRlZmluZWRcbj4oXG4gIHByb3BzOiBmdW5jdGlvbmxlc3MuVGFibGVQcm9wczxcbiAgICBFeGNsdWRlPFBLLCBudW1iZXIgfCBTeW1ib2w+LFxuICAgIEV4Y2x1ZGU8U0ssIG51bWJlciB8IFN5bWJvbD5cbiAgPlxuKTogVGFibGU8SXRlbSwgUEssIFNLPjtcblxuZXhwb3J0IGZ1bmN0aW9uIFRhYmxlPFxuICBJdGVtIGV4dGVuZHMgb2JqZWN0LFxuICBQSyBleHRlbmRzIGtleW9mIEl0ZW0sXG4gIFNLIGV4dGVuZHMga2V5b2YgSXRlbSB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZFxuPihcbiAgcHJvcHM6IGZ1bmN0aW9ubGVzcy5UYWJsZVByb3BzPFxuICAgIEV4Y2x1ZGU8UEssIG51bWJlciB8IFN5bWJvbD4sXG4gICAgRXhjbHVkZTxTSywgbnVtYmVyIHwgU3ltYm9sPlxuICA+LFxuICAvKipcbiAgICogSW5qZWN0ZWQgYnkgdGhlIGNvbXBpbGVyLlxuICAgKi9cbiAgcmVzb3VyY2VJZD86IHN0cmluZyxcbiAgLyoqXG4gICAqIEluamVjdGVkIGJ5IHRoZSBjb21waWxlci5cbiAgICovXG4gIHJvbGVBcm4/OiBzdHJpbmdcbik6IFRhYmxlPEl0ZW0sIFBLLCBTSz4ge1xuICByZXR1cm4gbmV3IFRhYmxlRG9jdW1lbnRDbGllbnQocHJvcHMgYXMgYW55LCByZXNvdXJjZUlkISwgcm9sZUFybikgYXMgYW55O1xufVxuXG5leHBvcnQgY2xhc3MgVGFibGVEb2N1bWVudENsaWVudDxcbiAgSXRlbSBleHRlbmRzIG9iamVjdCxcbiAgUEsgZXh0ZW5kcyBrZXlvZiBJdGVtLFxuICBTSyBleHRlbmRzIGtleW9mIEl0ZW0gfCB1bmRlZmluZWQgPSB1bmRlZmluZWRcbj4ge1xuICByZWFkb25seSBraW5kID0gVGFibGVLaW5kO1xuICByZWFkb25seSBhdHRyaWJ1dGVzOiBUYWJsZUF0dHJpYnV0ZXNDbGllbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgcHJvcHM6IGZ1bmN0aW9ubGVzcy5UYWJsZVByb3BzPFxuICAgICAgRXhjbHVkZTxQSywgbnVtYmVyIHwgU3ltYm9sPixcbiAgICAgIEV4Y2x1ZGU8U0ssIG51bWJlciB8IFN5bWJvbD5cbiAgICA+LFxuICAgIHJlYWRvbmx5IHJlc291cmNlSWQ6IHN0cmluZyxcbiAgICByZWFkb25seSByb2xlQXJuPzogc3RyaW5nXG4gICkge1xuICAgIHRoaXMuYXR0cmlidXRlcyA9IG5ldyBUYWJsZUF0dHJpYnV0ZXNDbGllbnQocmVzb3VyY2VJZCwgcm9sZUFybik7XG4gIH1cblxuICBwcml2YXRlIGdldEVudmlyb25tZW50S2V5KCkge1xuICAgIHJldHVybiBnZXRFbnZpcm9ubWVudFZhcmlhYmxlTmFtZSh0aGlzLnJlc291cmNlSWQpO1xuICB9XG5cbiAgcHVibGljIGdldFRhYmxlQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHByb2Nlc3MuZW52W2Ake3RoaXMuZ2V0RW52aXJvbm1lbnRLZXkoKX1fQVJOYF0hO1xuICB9XG5cbiAgcHVibGljIGdldFRhYmxlTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBwcm9jZXNzLmVudltgJHt0aGlzLmdldEVudmlyb25tZW50S2V5KCl9X05BTUVgXSE7XG4gIH1cblxuICBhc3luYyBnZXQocmVxdWVzdDogYW55KSB7XG4gICAgY29uc3QgaW5wdXQ6IGFueSA9IHtcbiAgICAgIC4uLnJlcXVlc3QsXG4gICAgICBUYWJsZU5hbWU6IHRoaXMuZ2V0VGFibGVOYW1lKCksXG4gICAgfTtcbiAgICByZXR1cm4gYXdhaXQgKGF3YWl0IGRvY3VtZW50Q2xpZW50KHRoaXMucm9sZUFybikpLmdldChpbnB1dCkucHJvbWlzZSgpO1xuICB9XG4gIGFzeW5jIHB1dChyZXF1ZXN0OiBhbnkpIHtcbiAgICBjb25zdCBpbnB1dDogYW55ID0ge1xuICAgICAgLi4ucmVxdWVzdCxcbiAgICAgIFRhYmxlTmFtZTogdGhpcy5nZXRUYWJsZU5hbWUoKSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGF3YWl0IChhd2FpdCBkb2N1bWVudENsaWVudCh0aGlzLnJvbGVBcm4pKS5wdXQoaW5wdXQpLnByb21pc2UoKTtcbiAgfVxuICBhc3luYyB1cGRhdGUocmVxdWVzdDogYW55KSB7XG4gICAgY29uc3QgaW5wdXQ6IGFueSA9IHtcbiAgICAgIC4uLnJlcXVlc3QsXG4gICAgICBUYWJsZU5hbWU6IHRoaXMuZ2V0VGFibGVOYW1lKCksXG4gICAgfTtcblxuICAgIHJldHVybiBhd2FpdCAoYXdhaXQgZG9jdW1lbnRDbGllbnQodGhpcy5yb2xlQXJuKSkudXBkYXRlKGlucHV0KS5wcm9taXNlKCk7XG4gIH1cbiAgYXN5bmMgZGVsZXRlKHJlcXVlc3Q6IGFueSkge1xuICAgIGNvbnN0IGlucHV0OiBhbnkgPSB7XG4gICAgICAuLi5yZXF1ZXN0LFxuICAgICAgVGFibGVOYW1lOiB0aGlzLmdldFRhYmxlTmFtZSgpLFxuICAgIH07XG5cbiAgICByZXR1cm4gYXdhaXQgKGF3YWl0IGRvY3VtZW50Q2xpZW50KHRoaXMucm9sZUFybikpLmRlbGV0ZShpbnB1dCkucHJvbWlzZSgpO1xuICB9XG4gIGFzeW5jIHF1ZXJ5KHJlcXVlc3Q6IGFueSkge1xuICAgIGNvbnN0IGlucHV0OiBhbnkgPSB7XG4gICAgICAuLi5yZXF1ZXN0LFxuICAgICAgVGFibGVOYW1lOiB0aGlzLmdldFRhYmxlTmFtZSgpLFxuICAgIH07XG5cbiAgICByZXR1cm4gYXdhaXQgKGF3YWl0IGRvY3VtZW50Q2xpZW50KHRoaXMucm9sZUFybikpLnF1ZXJ5KGlucHV0KS5wcm9taXNlKCk7XG4gIH1cbiAgYXN5bmMgc2NhbihyZXF1ZXN0OiBhbnkpIHtcbiAgICBjb25zdCBpbnB1dDogYW55ID0ge1xuICAgICAgLi4ucmVxdWVzdCxcbiAgICAgIFRhYmxlTmFtZTogdGhpcy5nZXRUYWJsZU5hbWUoKSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGF3YWl0IChhd2FpdCBkb2N1bWVudENsaWVudCh0aGlzLnJvbGVBcm4pKS5zY2FuKGlucHV0KS5wcm9taXNlKCk7XG4gIH1cbiAgYXN5bmMgYmF0Y2hHZXQocmVxdWVzdDogYW55KSB7XG4gICAgY29uc3QgaW5wdXQ6IGFueSA9IHtcbiAgICAgIFJlcXVlc3RJdGVtczoge1xuICAgICAgICBbdGhpcy5nZXRUYWJsZU5hbWUoKV06IHJlcXVlc3QsXG4gICAgICB9LFxuICAgIH07XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCAoYXdhaXQgZG9jdW1lbnRDbGllbnQodGhpcy5yb2xlQXJuKSlcbiAgICAgIC5iYXRjaEdldChpbnB1dClcbiAgICAgIC5wcm9taXNlKCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnJlc3BvbnNlLFxuICAgICAgSXRlbXM6IHJlc3BvbnNlLlJlc3BvbnNlcz8uW3RoaXMuZ2V0VGFibGVOYW1lKCldIGFzIGFueSxcbiAgICB9O1xuICB9XG4gIGFzeW5jIGJhdGNoV3JpdGUocmVxdWVzdDogYW55KSB7XG4gICAgY29uc3QgaW5wdXQ6IGFueSA9IHtcbiAgICAgIFJlcXVlc3RJdGVtczoge1xuICAgICAgICBbdGhpcy5nZXRUYWJsZU5hbWUoKV06IHJlcXVlc3QsXG4gICAgICB9LFxuICAgIH07XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCAoYXdhaXQgZG9jdW1lbnRDbGllbnQodGhpcy5yb2xlQXJuKSlcbiAgICAgIC5iYXRjaFdyaXRlKGlucHV0KVxuICAgICAgLnByb21pc2UoKTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi5yZXNwb25zZSxcbiAgICAgIFVucHJvY2Vzc2VkSXRlbXM6IHJlc3BvbnNlLlVucHJvY2Vzc2VkSXRlbXM/Llt0aGlzLmdldFRhYmxlTmFtZSgpXSBhcyBhbnksXG4gICAgfTtcbiAgfVxuICBhc3luYyB0cmFuc2FjdEdldCh7IFRyYW5zYWN0SXRlbXMgfTogYW55KSB7XG4gICAgY29uc3QgaW5wdXQ6IGFueSA9IHtcbiAgICAgIFRyYW5zYWN0SXRlbXM6IFRyYW5zYWN0SXRlbXMubWFwKChpdGVtOiBhbnkpID0+ICh7XG4gICAgICAgIEdldDoge1xuICAgICAgICAgIC4uLml0ZW0uR2V0LFxuICAgICAgICAgIFRhYmxlTmFtZTogdGhpcy5nZXRUYWJsZU5hbWUoKSxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICB9O1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgKGF3YWl0IGRvY3VtZW50Q2xpZW50KHRoaXMucm9sZUFybikpXG4gICAgICAudHJhbnNhY3RHZXQoaW5wdXQpXG4gICAgICAucHJvbWlzZSgpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIEl0ZW1zOiByZXNwb25zZS5SZXNwb25zZXM/Lm1hcCgoeyBJdGVtIH0pID0+IEl0ZW0pLFxuICAgIH0gYXMgYW55O1xuICB9XG4gIGFzeW5jIHRyYW5zYWN0V3JpdGUoeyBUcmFuc2FjdEl0ZW1zIH06IGFueSkge1xuICAgIGNvbnN0IGlucHV0OiBBV1MuRHluYW1vREIuVHJhbnNhY3RXcml0ZUl0ZW1zSW5wdXQgPSB7XG4gICAgICBUcmFuc2FjdEl0ZW1zOiBUcmFuc2FjdEl0ZW1zLmZsYXRNYXAoKGl0ZW06IGFueSkgPT5cbiAgICAgICAgT2JqZWN0LmtleXMoaXRlbSkubWFwKChrZXkpID0+ICh7XG4gICAgICAgICAgW2tleV06IHtcbiAgICAgICAgICAgIC4uLml0ZW1ba2V5IGFzIGtleW9mIHR5cGVvZiBpdGVtXSxcbiAgICAgICAgICAgIFRhYmxlTmFtZTogdGhpcy5nZXRUYWJsZU5hbWUoKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSlcbiAgICAgICksXG4gICAgfTtcbiAgICByZXR1cm4gYXdhaXQgKGF3YWl0IGRvY3VtZW50Q2xpZW50KHRoaXMucm9sZUFybikpXG4gICAgICAudHJhbnNhY3RXcml0ZShpbnB1dClcbiAgICAgIC5wcm9taXNlKCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFRhYmxlQXR0cmlidXRlc0NsaWVudCB7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHJlc291cmNlSWQ6IHN0cmluZywgcmVhZG9ubHkgcm9sZUFybj86IHN0cmluZykge31cblxuICBwcml2YXRlIGdldEVudmlyb25tZW50S2V5KCkge1xuICAgIHJldHVybiBnZXRFbnZpcm9ubWVudFZhcmlhYmxlTmFtZSh0aGlzLnJlc291cmNlSWQpO1xuICB9XG5cbiAgcHVibGljIGdldFRhYmxlQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHByb2Nlc3MuZW52W2Ake3RoaXMuZ2V0RW52aXJvbm1lbnRLZXkoKX1fQVJOYF0hO1xuICB9XG5cbiAgcHVibGljIGdldFRhYmxlTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBwcm9jZXNzLmVudltgJHt0aGlzLmdldEVudmlyb25tZW50S2V5KCl9X05BTUVgXSE7XG4gIH1cblxuICBhc3luYyBnZXQocmVxdWVzdDogYW55KSB7XG4gICAgY29uc3QgaW5wdXQ6IGFueSA9IHtcbiAgICAgIC4uLnJlcXVlc3QsXG4gICAgICBUYWJsZU5hbWU6IHRoaXMuZ2V0VGFibGVOYW1lKCksXG4gICAgfTtcbiAgICByZXR1cm4gYXdhaXQgKGF3YWl0IGR5bmFtb0NsaWVudCh0aGlzLnJvbGVBcm4pKS5nZXRJdGVtKGlucHV0KS5wcm9taXNlKCk7XG4gIH1cbiAgYXN5bmMgcHV0KHJlcXVlc3Q6IGFueSkge1xuICAgIGNvbnN0IGlucHV0OiBhbnkgPSB7XG4gICAgICAuLi5yZXF1ZXN0LFxuICAgICAgVGFibGVOYW1lOiB0aGlzLmdldFRhYmxlTmFtZSgpLFxuICAgIH07XG5cbiAgICByZXR1cm4gYXdhaXQgKGF3YWl0IGR5bmFtb0NsaWVudCh0aGlzLnJvbGVBcm4pKS5wdXRJdGVtKGlucHV0KS5wcm9taXNlKCk7XG4gIH1cbiAgYXN5bmMgdXBkYXRlKHJlcXVlc3Q6IGFueSkge1xuICAgIGNvbnN0IGlucHV0OiBhbnkgPSB7XG4gICAgICAuLi5yZXF1ZXN0LFxuICAgICAgVGFibGVOYW1lOiB0aGlzLmdldFRhYmxlTmFtZSgpLFxuICAgIH07XG5cbiAgICByZXR1cm4gYXdhaXQgKGF3YWl0IGR5bmFtb0NsaWVudCh0aGlzLnJvbGVBcm4pKS51cGRhdGVJdGVtKGlucHV0KS5wcm9taXNlKCk7XG4gIH1cbiAgYXN5bmMgZGVsZXRlKHJlcXVlc3Q6IGFueSkge1xuICAgIGNvbnN0IGlucHV0OiBhbnkgPSB7XG4gICAgICAuLi5yZXF1ZXN0LFxuICAgICAgVGFibGVOYW1lOiB0aGlzLmdldFRhYmxlTmFtZSgpLFxuICAgIH07XG5cbiAgICByZXR1cm4gYXdhaXQgKGF3YWl0IGR5bmFtb0NsaWVudCh0aGlzLnJvbGVBcm4pKS5kZWxldGVJdGVtKGlucHV0KS5wcm9taXNlKCk7XG4gIH1cbiAgYXN5bmMgcXVlcnkocmVxdWVzdDogYW55KSB7XG4gICAgY29uc3QgaW5wdXQ6IGFueSA9IHtcbiAgICAgIC4uLnJlcXVlc3QsXG4gICAgICBUYWJsZU5hbWU6IHRoaXMuZ2V0VGFibGVOYW1lKCksXG4gICAgfTtcblxuICAgIHJldHVybiBhd2FpdCAoYXdhaXQgZHluYW1vQ2xpZW50KHRoaXMucm9sZUFybikpLnF1ZXJ5KGlucHV0KS5wcm9taXNlKCk7XG4gIH1cbiAgYXN5bmMgc2NhbihyZXF1ZXN0OiBhbnkpIHtcbiAgICBjb25zdCBpbnB1dDogYW55ID0ge1xuICAgICAgLi4ucmVxdWVzdCxcbiAgICAgIFRhYmxlTmFtZTogdGhpcy5nZXRUYWJsZU5hbWUoKSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGF3YWl0IChhd2FpdCBkeW5hbW9DbGllbnQodGhpcy5yb2xlQXJuKSkuc2NhbihpbnB1dCkucHJvbWlzZSgpO1xuICB9XG4gIGFzeW5jIGJhdGNoR2V0KHJlcXVlc3Q6IGFueSkge1xuICAgIGNvbnN0IGlucHV0OiBhbnkgPSB7XG4gICAgICBSZXF1ZXN0SXRlbXM6IHtcbiAgICAgICAgW3RoaXMuZ2V0VGFibGVOYW1lKCldOiByZXF1ZXN0LFxuICAgICAgfSxcbiAgICB9O1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgKGF3YWl0IGR5bmFtb0NsaWVudCh0aGlzLnJvbGVBcm4pKVxuICAgICAgLmJhdGNoR2V0SXRlbShpbnB1dClcbiAgICAgIC5wcm9taXNlKCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnJlc3BvbnNlLFxuICAgICAgSXRlbXM6IHJlc3BvbnNlLlJlc3BvbnNlcz8uW3RoaXMuZ2V0VGFibGVOYW1lKCldIGFzIGFueSxcbiAgICB9O1xuICB9XG4gIGFzeW5jIGJhdGNoV3JpdGUocmVxdWVzdDogYW55KSB7XG4gICAgY29uc3QgaW5wdXQ6IGFueSA9IHtcbiAgICAgIFJlcXVlc3RJdGVtczoge1xuICAgICAgICBbdGhpcy5nZXRUYWJsZU5hbWUoKV06IHJlcXVlc3QsXG4gICAgICB9LFxuICAgIH07XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCAoYXdhaXQgZHluYW1vQ2xpZW50KHRoaXMucm9sZUFybikpXG4gICAgICAuYmF0Y2hXcml0ZUl0ZW0oaW5wdXQpXG4gICAgICAucHJvbWlzZSgpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnJlc3BvbnNlLFxuICAgICAgVW5wcm9jZXNzZWRJdGVtczogcmVzcG9uc2UuVW5wcm9jZXNzZWRJdGVtcz8uW3RoaXMuZ2V0VGFibGVOYW1lKCldIGFzIGFueSxcbiAgICB9O1xuICB9XG4gIGFzeW5jIHRyYW5zYWN0R2V0KHsgVHJhbnNhY3RJdGVtcyB9OiBhbnkpIHtcbiAgICBjb25zdCBpbnB1dDogYW55ID0ge1xuICAgICAgVHJhbnNhY3RJdGVtczogVHJhbnNhY3RJdGVtcy5tYXAoKGl0ZW06IGFueSkgPT4gKHtcbiAgICAgICAgR2V0OiB7XG4gICAgICAgICAgLi4uaXRlbS5HZXQsXG4gICAgICAgICAgVGFibGVOYW1lOiB0aGlzLmdldFRhYmxlTmFtZSgpLFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgIH07XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCAoYXdhaXQgZHluYW1vQ2xpZW50KHRoaXMucm9sZUFybikpXG4gICAgICAudHJhbnNhY3RHZXRJdGVtcyhpbnB1dClcbiAgICAgIC5wcm9taXNlKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgSXRlbXM6IHJlc3BvbnNlLlJlc3BvbnNlcz8ubWFwKCh7IEl0ZW0gfSkgPT4gSXRlbSksXG4gICAgfSBhcyBhbnk7XG4gIH1cbiAgYXN5bmMgdHJhbnNhY3RXcml0ZSh7IFRyYW5zYWN0SXRlbXMgfTogYW55KSB7XG4gICAgY29uc3QgaW5wdXQ6IEFXUy5EeW5hbW9EQi5UcmFuc2FjdFdyaXRlSXRlbXNJbnB1dCA9IHtcbiAgICAgIFRyYW5zYWN0SXRlbXM6IFRyYW5zYWN0SXRlbXMuZmxhdE1hcCgoaXRlbTogYW55KSA9PlxuICAgICAgICBPYmplY3Qua2V5cyhpdGVtKS5tYXAoKGtleSkgPT4gKHtcbiAgICAgICAgICBba2V5XToge1xuICAgICAgICAgICAgLi4uaXRlbVtrZXkgYXMga2V5b2YgdHlwZW9mIGl0ZW1dLFxuICAgICAgICAgICAgVGFibGVOYW1lOiB0aGlzLmdldFRhYmxlTmFtZSgpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pKVxuICAgICAgKSxcbiAgICB9O1xuICAgIHJldHVybiBhd2FpdCAoYXdhaXQgZHluYW1vQ2xpZW50KHRoaXMucm9sZUFybikpXG4gICAgICAudHJhbnNhY3RXcml0ZUl0ZW1zKGlucHV0KVxuICAgICAgLnByb21pc2UoKTtcbiAgfVxufVxuIl19